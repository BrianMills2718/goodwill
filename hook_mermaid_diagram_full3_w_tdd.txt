flowchart TD
  %% AUTONOMOUS TDD WORKFLOW WITH HOOK ORCHESTRATION
%% Cross-Reference: claude_code_and_repo_structuring_and_tools_etc_any_projectv2.md
%% Sections 17-22 contain detailed implementation specifications

  A["ENTRY:\nSessionStart Hook → workflow_orchestrator.py"]:::startend
  LOAD["/load_phase_plans/\nRead phases.md → Update CLAUDE.md state"]:::review

  %% ---------------- TDD WITHIN-PHASE LOOP ----------------
  subgraph W[TDD WITHIN-PHASE LOOP]
    direction TB

    EXPLORE["/explore/\nRead files, identify unknowns\n(PreToolUse: validate_references.py)"]:::process
    
    TESTS["/write_tests/\nTDD: Define success criteria first\n(PostToolUse: evidence_validator.py)"]:::process
    
    IMPLEMENT["/implement/\nCode to pass tests\n(PostToolUse: evidence_validator.py,\ndiscovery_classifier.py)"]:::process
    
    RUN_TESTS["/run_tests/\nExecute test suite\n(PostToolUse: evidence_validator.py)"]:::process
    
    D_tests{"tests_pass == true\nAND coverage >= 80%"}:::decision
    
    DOUBLECHECK["/doublecheck/\nVerify implementation vs requirements\n(PostToolUse: evidence_validator.py,\ndiscovery_classifier.py)"]:::process
    
    D_issues{"has_issues == true\n(test failures, gaps, discoveries)"}:::decision
    
    %% ----- UNCERTAINTY RESOLUTION -----
    subgraph UR[UNCERTAINTY RESOLUTION]
      direction TB
      
      CATEGORIZE["/categorize_uncertainties/\nStrategic vs Pre-implementation vs Implementation\n(Tool: uncertainty_resolver.py)"]:::process
      
      D_type{"uncertainty_type"}:::decision
      
      STRATEGIC["/review_architecture_behavior/\nCheck docs for guidance\n(PostToolUse: discovery_classifier.py)"]:::process
      
      INVESTIGATE["/investigate_pre_impl/\nResearch unknowns\n(PostToolUse: evidence_validator.py)"]:::process
      
      UPDATE_PLANS["/update_plans_within_phase/\nIntegrate findings → CLAUDE.md\n(PostToolUse: checkpoint_commit)"]:::process
      
      D_loop{"loop_count >= 7"}:::decision
      ESCALATE["/escalate_to_deferred/\nArchive to investigations/deferred/"]:::process
    end
    
    D_phase_done{"phase_complete == true\nAND confidence == High\nAND all_tests_pass == true"}:::decision
    
    CLOSE["/close_phase/\nArchive evidence → archive/investigations/\nUpdate phases.md\n(PostToolUse: evidence_archive)"]:::process
  end

  %% ---------------- BETWEEN-PHASE ----------------
  subgraph B[BETWEEN-PHASE TRANSITION]
    direction TB
    
    VALIDATE["/validate_phase_completion/\nVerify evidence, test coverage, quality"]:::review
    
    D_valid{"validation_passed == true"}:::decision
    
    REVIEW_DOCS["/review_docs_between_phases/\nCheck architecture/behavior alignment"]:::review
    
    D_more{"more_phases == true"}:::decision
    
    LOAD_NEXT["/load_next_phase/\nUpdate CLAUDE.md with next phase"]:::process
    
    COMPLETE["PROJECT COMPLETE:\nAll phases done,\nhigh confidence,\nfull test coverage"]:::startend
  
  RECOVERY["/session_recovery/\nSessionStart: Read workflow_state\nfrom CLAUDE.md → Resume at\ncurrent_command"]:::process
  end

  %% ---------------- HOOK ORCHESTRATION ----------------
  subgraph H[HOOK SYSTEM - CONTINUOUS AUTOMATION]
    direction TB
    
    STOP_HOOK["Stop Hook:\nworkflow_orchestrator.py\nReads CLAUDE.md state\n→ Injects next command"]:::hook
    
    POST_HOOK["PostToolUse Hook:\nevidence_validator.py\ndiscovery_classifier.py\n→ Validates & classifies"]:::hook
    
    PRE_HOOK["PreToolUse Hook:\nvalidate_references.py\n→ Ensures integrity"]:::hook
    
    QUALITY["Quality Gates:\n- No hardcoded secrets\n- Cross-reference integrity\n- Evidence completeness\n- Test coverage >= 80%"]:::hook
  end

  %% ---------------- EVIDENCE & STATE TRACKING ----------------
  subgraph E[EVIDENCE & STATE MANAGEMENT]
    direction TB
    
    STATE["CLAUDE.md Workflow State:\n{\n  current_command: '/implement',\n  current_phase: 'phase_2',\n  loop_iterations: 3,\n  test_status: 'passing',\n  confidence: 'high'\n}"]:::state
    
    EVIDENCE["Evidence Structure:\ninvestigations/[area]/phase_X/\n├─ findings.md\n├─ test_results.log\n└─ implementation_proof.md"]:::state
    
    ARCHIVE["Archive on Completion:\narchive/investigations/[area]/\nYYYYMMDD_phase_X/"]:::state
  end

  %% ---------------- MAIN FLOW CONNECTIONS ----------------
  A --> LOAD --> EXPLORE

  %% TDD Loop
  EXPLORE --> TESTS --> IMPLEMENT --> RUN_TESTS --> D_tests
  D_tests --"No"---> CATEGORIZE
  D_tests --"Yes"---> DOUBLECHECK --> D_issues
  
  %% Issue Resolution
  D_issues --"Yes"---> CATEGORIZE
  D_issues --"No"---> D_phase_done
  
  %% Uncertainty Resolution
  CATEGORIZE --> D_type
  D_type --"Strategic"---> STRATEGIC --> UPDATE_PLANS
  D_type --"Pre-impl"---> INVESTIGATE --> UPDATE_PLANS
  D_type --"Implementation"---> RUN_TESTS
  
  UPDATE_PLANS --> D_loop
  D_loop --"Yes"---> ESCALATE --> D_phase_done
  D_loop --"No"---> EXPLORE
  
  %% Phase Completion
  D_phase_done --"No"---> CATEGORIZE
  D_phase_done --"Yes"---> CLOSE --> VALIDATE --> D_valid
  
  %% Between Phase
  D_valid --"No"---> CATEGORIZE
  D_valid --"Yes"---> REVIEW_DOCS --> D_more
  D_more --"Yes"---> LOAD_NEXT --> EXPLORE
  D_more --"No"---> COMPLETE

  %% Hook Integration (dotted lines show automation)
  EXPLORE -.-> PRE_HOOK
  TESTS -.-> POST_HOOK
  IMPLEMENT -.-> POST_HOOK
  RUN_TESTS -.-> POST_HOOK
  DOUBLECHECK -.-> POST_HOOK
  STRATEGIC -.-> POST_HOOK
  INVESTIGATE -.-> POST_HOOK
  UPDATE_PLANS -.-> POST_HOOK
  CLOSE -.-> POST_HOOK
  
  STOP_HOOK -.-> STATE
  POST_HOOK -.-> EVIDENCE
  CLOSE -.-> ARCHIVE
  
  QUALITY -.-> D_tests
  QUALITY -.-> D_phase_done
  
  %% Session Recovery
  A -.-> RECOVERY
  RECOVERY -.-> EXPLORE

  %% ---------------- STYLES ----------------
  classDef startend fill:#bbf,stroke:#225,stroke-width:2px,color:#000,rx:10,ry:10;
  classDef decision fill:#ffd,stroke:#aa0,stroke-width:2px,color:#000;
  classDef process fill:#eef,stroke:#55f,stroke-width:1px,color:#000;
  classDef review fill:#fce,stroke:#c4a,stroke-width:1px,color:#000;
  classDef hook fill:#efe,stroke:#4a4,stroke-width:2px,color:#000;
  classDef state fill:#fee,stroke:#c44,stroke-width:1px,color:#000;