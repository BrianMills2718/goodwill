# Claude Code Hooks: V6 Hybrid Intelligence with Planning Input Enhancement

## Decision Node Intelligence Classification

**Legend:**
- ü§ñ **PROGRAMMATIC** - Clear binary/numeric checks, fast execution
- üß† **LLM** - Requires human-like judgment and reasoning
- ‚ö° **HYBRID** - Programmatic first, LLM analysis if needed

```mermaid
flowchart TD
    Start([Stop Hook Triggered]) --> ManualOverride{ü§ñ Manual Override File Exists?}
    
    ManualOverride -->|Yes| StopAutomation["`**STOP**: Manual override active
    Remove .claude/workflow_override to resume`"]
    
    ManualOverride -->|No| PlanningInputCheck{ü§ñ Planning Artifacts Available?}
    
    %% V6 ENHANCEMENT: PLANNING INPUT HANDLING WITH MODE SELECTION
    PlanningInputCheck -->|Yes| LoadPlanningContext[ü§ñ Load Planning Context]
    PlanningInputCheck -->|No| SafetyLimits{ü§ñ Safety Limits Check}
    
    LoadPlanningContext --> ReadCurrentPhase[ü§ñ Read Current Implementation Phase]
    ReadCurrentPhase --> LoadRelevantPseudocode[ü§ñ Load Relevant Pseudocode]
    LoadRelevantPseudocode --> LoadTaskGraph[ü§ñ Load Implementation Task Graph]
    LoadTaskGraph --> IdentifyImplementationTargets[ü§ñ Identify Available Implementation Targets]
    IdentifyImplementationTargets --> ModeSelection{üß† LLM: Select Implementation Mode}
    
    %% V6 ENHANCEMENT: IMPLEMENTATION MODE SELECTION
    ModeSelection -->|"Task graph has clear next target<br/>with ready pseudocode"| TaskGraphMode[Task-Graph Driven Mode]
    ModeSelection -->|"Multiple failing tests<br/>need failure-driven approach"| TDDMode[TDD Failure-Driven Mode]
    ModeSelection -->|"Mixed situation requiring<br/>hybrid approach"| HybridMode[Hybrid Planning+TDD Mode]
    ModeSelection -->|"Planning context unclear<br/>or insufficient"| FallbackTDDMode[Fallback to Pure TDD Mode]
    
    %% V6 ENHANCEMENT: IMPLEMENTATION MODE EXECUTION
    TaskGraphMode --> LoadTaskGraphTarget[ü§ñ Load Next Task Graph Target]
    TDDMode --> AnalyzeTestFailures[ü§ñ Analyze Current Test Failures]
    HybridMode --> ContextualPrioritization{üß† LLM: Prioritize Based on Context}
    FallbackTDDMode --> SafetyLimits
    
    %% TASK-GRAPH DRIVEN EXECUTION
    LoadTaskGraphTarget --> ValidateTaskDependencies[ü§ñ Validate Task Dependencies Met]
    ValidateTaskDependencies -->|Dependencies ready| GenerateTaskInstruction[üß† LLM: Generate Task Implementation Instruction]
    ValidateTaskDependencies -->|Dependencies missing| ResolveDependencies[Execute: Resolve Dependencies First]
    
    %% TDD FAILURE-DRIVEN EXECUTION  
    AnalyzeTestFailures --> TestLayerConflictCheck{ü§ñ Check Test Layer Conflicts}
    TestLayerConflictCheck -->|No conflicts| SelectFailureToFix[üß† LLM: Select Test Failure to Fix]
    TestLayerConflictCheck -->|Conflicts detected| ResolveTestLayerConflicts[üß† LLM: Resolve Test Layer Conflicts]
    
    %% HYBRID MODE EXECUTION
    ContextualPrioritization -->|Task graph priority higher| LoadTaskGraphTarget
    ContextualPrioritization -->|Test failure priority higher| AnalyzeTestFailures
    ContextualPrioritization -->|Equal priority - use planning| ConsultPlanningStrategy[üß† LLM: Consult Planning Strategy]
    
    ConsultPlanningStrategy --> LoadTaskGraphTarget
    
    %% EXECUTION CONVERGENCE
    GenerateTaskInstruction --> ExecuteImplementation[Execute: Implement Component]
    ResolveDependencies --> ExecuteImplementation
    SelectFailureToFix --> ExecuteImplementation
    ResolveTestLayerConflicts --> ExecuteImplementation
    
    ExecuteImplementation --> TestStatus{ü§ñ Run Tests}
    
    %% ORIGINAL V5 FLOW WITH ENHANCEMENTS
    %% V6 ENHANCEMENT: DETAILED SAFETY LIMITS AND LOOP BREAKING
    SafetyLimits --> CheckIterationLimits{ü§ñ Check Iteration Limits}
    CheckIterationLimits -->|"loop_iterations >= 7"| UncertaintyResolutionLimit[Uncertainty Resolution Loop Limit]
    CheckIterationLimits -->|"stop_hooks >= 3"| StopHookLoopLimit[Stop Hook Loop Limit]
    CheckIterationLimits -->|"Within all limits"| QualityValidationPipeline{ü§ñ Quality Validation Pipeline}
    
    UncertaintyResolutionLimit --> EscalationStrategy{üß† LLM: Select Escalation Strategy}
    StopHookLoopLimit --> ManualOverrideCreation[ü§ñ Create Manual Override]
    
    EscalationStrategy -->|Archive and skip| EscalateToDeferred[Execute: Archive to investigations/deferred/]
    EscalationStrategy -->|Simplify objective| SimplifyObjective[üß† LLM: Reduce Scope to Achievable Subset]
    EscalationStrategy -->|Human escalation| EscalateManual["`**ESCALATE**: Loop limit exceeded
    Human intervention required`"]
    
    ManualOverrideCreation --> CreateWorkflowOverride[ü§ñ Create .workflow_override file]
    CreateWorkflowOverride --> EscalateManual
    
    %% V6 ENHANCEMENT: QUALITY VALIDATION PIPELINE
    QualityValidationPipeline --> CrossReferenceIntegrityCheck[ü§ñ Check Cross-Reference Integrity]
    CrossReferenceIntegrityCheck -->|Valid| EvidenceCompletenessCheck[ü§ñ Check Evidence Completeness]
    CrossReferenceIntegrityCheck -->|Invalid| InjectCrossReferenceError[ü§ñ Inject Cross-Reference Error]
    
    EvidenceCompletenessCheck -->|Complete| StateConsistencyCheck[ü§ñ Check State Consistency]
    EvidenceCompletenessCheck -->|Incomplete| InjectEvidenceError[ü§ñ Inject Evidence Error]
    
    StateConsistencyCheck -->|Consistent| AutomationHealthCheck[ü§ñ Check Automation Health]
    StateConsistencyCheck -->|Inconsistent| InjectStateError[ü§ñ Inject State Inconsistency Error]
    
    AutomationHealthCheck -->|Healthy| TestStatus{ü§ñ Run Tests}
    AutomationHealthCheck -->|Unhealthy| InjectAutomationError[ü§ñ Inject Automation Health Error]
    
    %% V6 ENHANCEMENT: ERROR INJECTION WORKFLOW
    InjectCrossReferenceError --> CreateErrorLog[ü§ñ Create Error Log in logs/errors/active/]
    InjectEvidenceError --> CreateErrorLog
    InjectStateError --> CreateErrorLog
    InjectAutomationError --> CreateErrorLog
    
    CreateErrorLog --> UpdateErrorSummary[ü§ñ Update Error Summary JSON]
    UpdateErrorSummary --> InjectCLAUDEMDError[ü§ñ Inject Error into CLAUDE.md Active Errors]
    InjectCLAUDEMDError --> EscalateManual
    
    EscalateToDeferred --> ArchiveEvidence[Execute: Archive Evidence to investigations/deferred/]
    SimplifyObjective --> UpdatePlanningObjective[üß† LLM: Update Planning Objective]
    ArchiveEvidence --> TestStatus
    UpdatePlanningObjective --> TestStatus
    
    TestStatus -->|pytest returncode == 0| TestsPass[Tests Passing ‚úÖ]
    TestStatus -->|pytest returncode != 0| TestsFail[Tests Failing ‚ùå]
    
    %% TESTS PASSING PATH (Enhanced)
    TestsPass --> GitChanges{ü§ñ Git Changes Since Last Commit?}
    
    GitChanges -->|"git diff --name-only<br/>has output"| HasChanges[Changes Detected]
    GitChanges -->|No changes| NoChanges[No Changes]
    
    HasChanges --> ProgressAnalysis{üß† LLM: Analyze Progress Quality}
    NoChanges --> StagnationAnalysis{üß† LLM: Why No Changes?}
    
    %% PROGRESS ANALYSIS (Enhanced with Planning Context)
    ProgressAnalysis -->|Real progress toward planning goals| CommitReady{üß† LLM: Ready to Commit?}
    ProgressAnalysis -->|Busywork/scaffolding| ContinueImplement[Continue Implementation]
    ProgressAnalysis -->|Unclear progress| EvidenceValidation[Validate Evidence]
    ProgressAnalysis -->|Progress contradicts planning| PlanningInconsistencyDetected{üö® Planning Inconsistency Detected}
    
    %% COMMIT READINESS (Enhanced)
    CommitReady -->|Component implementation complete| DoCommit[Execute: git commit]
    CommitReady -->|Need more work on current component| ContinueImplement
    CommitReady -->|Need verification against planning| RunPlanningDoublecheck[Execute: Verify Against Pseudocode]
    CommitReady -->|Ready for next planning target| ReturnToPlanningSelection[Return to Planning-Guided Selection]
    
    %% STAGNATION ANALYSIS (Enhanced)
    StagnationAnalysis -->|Thinking about planning approach| ContinueWork[Continue Current Phase]
    StagnationAnalysis -->|Stuck on planning implementation| PlanningImplementationProblem{üß† LLM: Diagnose Planning vs Implementation Issue}
    StagnationAnalysis -->|Wrong approach for planning goal| PivotToPlanningStrategy[Pivot to Different Planning Approach]
    
    %% NEW: PLANNING IMPLEMENTATION PROBLEM DIAGNOSIS
    PlanningImplementationProblem -->|Implementation complexity issue| ProblemSolving{üß† LLM: Diagnose Implementation Blocker}
    PlanningImplementationProblem -->|Pseudocode insufficient/unclear| PlanningInconsistencyDetected
    PlanningImplementationProblem -->|Missing planning context| LoadAdditionalPlanningContext[Load Additional Planning Context]
    
    %% TESTS FAILING PATH (Enhanced)
    TestsFail --> FailureCount{ü§ñ Count Recent Failures}
    
    FailureCount -->|"< 3 failures"| AnalyzeFailure{‚ö° HYBRID: Analyze Test Failures}
    FailureCount -->|">= 3 failures"| RepeatedFailure{üß† LLM: Pattern Analysis}
    
    %% HYBRID FAILURE ANALYSIS (Enhanced)
    AnalyzeFailure --> SimpleFailure{ü§ñ Simple Error Pattern?}
    
    SimpleFailure -->|"Syntax error<br/>Import error<br/>Missing file"| QuickFix[Execute: Fix Simple Error]
    SimpleFailure -->|Complex failure| LLMFailureAnalysis{üß† LLM: Deep Failure Analysis}
    
    %% COMPLEX FAILURE ANALYSIS (Enhanced with Planning Context)
    LLMFailureAnalysis -->|Logic error in implementation| FixImplementation[Fix Implementation Logic]
    LLMFailureAnalysis -->|Test issue unrelated to planning| TestIssueAnalysis{üß† LLM: Test Issue Classification}
    LLMFailureAnalysis -->|Architecture problem within planning| Refactor[Refactor Approach]
    LLMFailureAnalysis -->|Requirements unclear in planning| ClarifyRequirements[Clarify Requirements]
    LLMFailureAnalysis -->|Implementation contradicts pseudocode| PlanningInconsistencyDetected
    LLMFailureAnalysis -->|Test expectations contradict planning| PlanningInconsistencyDetected
    
    %% TEST ISSUE CLASSIFICATION (Enhanced)
    TestIssueAnalysis -->|Test logic error| FixTests[Fix Test Logic]
    TestIssueAnalysis -->|Test specification inconsistent with planning| PlanningInconsistencyDetected
    
    %% V6 ENHANCEMENT: TEST LAYER CONFLICT RESOLUTION
    ResolveTestLayerConflicts --> IdentifyConflictType{üß† LLM: Identify Conflict Type}
    IdentifyConflictType -->|"Acceptance vs Unit test disagreement"| ResolveAcceptanceUnitConflict[üß† LLM: Resolve Acceptance-Unit Conflict]
    IdentifyConflictType -->|"Contract vs Implementation test disagreement"| ResolveContractImplConflict[üß† LLM: Resolve Contract-Implementation Conflict]
    IdentifyConflictType -->|"External vs Internal test disagreement"| ResolveExternalInternalConflict[üß† LLM: Resolve External-Internal Conflict]
    IdentifyConflictType -->|"Multiple test layers failing differently"| ResolveMultiLayerConflict[üß† LLM: Resolve Multi-Layer Conflict]
    
    ResolveAcceptanceUnitConflict --> ValidateTestResolution[üß† LLM: Validate Test Resolution]
    ResolveContractImplConflict --> ValidateTestResolution
    ResolveExternalInternalConflict --> ValidateTestResolution
    ResolveMultiLayerConflict --> ValidateTestResolution
    
    ValidateTestResolution -->|Resolution valid| SelectFailureToFix
    ValidateTestResolution -->|Resolution invalid| PlanningInconsistencyDetected
    
    %% V6 ENHANCEMENT: PLANNING INCONSISTENCY HANDLING
    PlanningInconsistencyDetected --> CreatePlanningEvidencePackage[ü§ñ Create Planning Evidence Package]
    CreatePlanningEvidencePackage --> GatherPlanningContext[ü§ñ Gather Relevant Planning Artifacts]
    GatherPlanningContext --> DocumentImplementationFinding[ü§ñ Document Implementation vs Planning Contradiction]
    DocumentImplementationFinding --> FreshInstanceEval{üß† FRESH: Evaluate Planning Issue}
    
    %% V6 ENHANCEMENT: COMPREHENSIVE FRESH INSTANCE EVALUATOR
    FreshInstanceEval --> SpawnEvaluatorInstance[ü§ñ Spawn Fresh Evaluator Instance via Task Tool]
    SpawnEvaluatorInstance --> EvaluatorAssessment{üß† FRESH EVALUATOR: Assess Changes}
    
    EvaluatorAssessment -->|"Legitimate addition<br/>(necessary steps discovered)"| ApprovedChange[‚úÖ Evaluator Approved: Legitimate Addition]
    EvaluatorAssessment -->|"Scope reduction<br/>(removing requirements)"| RejectedScopeReduction[‚ùå Evaluator Rejected: Scope Reduction]
    EvaluatorAssessment -->|"Quality compromise<br/>(lowering standards)"| RejectedQualityCompromise[‚ùå Evaluator Rejected: Quality Compromise]
    EvaluatorAssessment -->|"Requirements unclear<br/>(need clarification)"| RequestRequirementsClarification[üìã Evaluator: Clarify Requirements]
    
    ApprovedChange --> LogEvaluatorDecision[ü§ñ Log Evaluator Decision to .claude/evaluations/]
    RejectedScopeReduction --> LogEvaluatorDecision
    RejectedQualityCompromise --> LogEvaluatorDecision
    RequestRequirementsClarification --> LogEvaluatorDecision
    
    LogEvaluatorDecision --> EvaluatorDecisionRouting{ü§ñ Route Based on Evaluator Decision}
    
    EvaluatorDecisionRouting -->|Approved| ReturnToImplementationFlow[Return to Implementation Flow]
    EvaluatorDecisionRouting -->|Rejected - Scope| BlockChangeAndContinue[Block Change and Continue Current Approach]
    EvaluatorDecisionRouting -->|Rejected - Quality| BlockChangeAndContinue
    EvaluatorDecisionRouting -->|Clarification| RequestPlanningClarification[Request Planning Clarification]
    
    %% ANTI-CHEATING ENFORCEMENT
    BlockChangeAndContinue --> AntiCheatingEnforcement[ü§ñ Enforce Anti-Cheating Patterns]
    AntiCheatingEnforcement --> DetectCheatingPatterns{ü§ñ Detect Cheating Patterns}
    
    DetectCheatingPatterns -->|"Test modification attempt"| BlockTestModification[‚ùå Block: Test Modification Forbidden]
    DetectCheatingPatterns -->|"Mock data substitution"| BlockMockDataUsage[‚ùå Block: Use Real Data Required]
    DetectCheatingPatterns -->|"Requirement dropping"| BlockRequirementDropping[‚ùå Block: All Requirements Must Be Met]
    DetectCheatingPatterns -->|"No cheating detected"| ReturnToImplementationFlow
    
    BlockTestModification --> EscalateHuman[Escalate to Human: Anti-Cheating Violation]
    BlockMockDataUsage --> EscalateHuman
    BlockRequirementDropping --> EscalateHuman
    
    ControlledPlanningReturn --> InvalidatePlanningArtifacts[Invalidate Affected Planning Artifacts]
    InvalidatePlanningArtifacts --> RerunPlanningSegment[Re-run Affected Planning Phases]
    RerunPlanningSegment --> GenerateNewPlanningArtifacts[Generate New Planning Artifacts]
    GenerateNewPlanningArtifacts --> HandoffToImplementation[Handoff New Artifacts to Implementation]
    
    %% REPEATED FAILURE PATTERN (Enhanced)
    RepeatedFailure -->|Same error pattern in planning implementation| StuckOnPlanningProblem{üß† LLM: Planning vs Implementation Escalation}
    RepeatedFailure -->|Different failures across planning components| SystemicPlanningIssue[Address Systemic Planning Issue]
    
    %% ESCALATION DECISIONS (Enhanced)
    StuckOnPlanningProblem -->|Can solve with different implementation approach| NewImplementationStrategy[Try New Implementation Strategy]
    StuckOnPlanningProblem -->|Planning appears fundamentally flawed| PlanningInconsistencyDetected
    StuckOnPlanningProblem -->|Need more planning context| GatherContext[Gather More Planning Context]
    StuckOnPlanningProblem -->|Need human expertise| EscalateHuman
    
    %% PROBLEM SOLVING (Enhanced with Planning Context)
    ProblemSolving -->|Missing dependency for planned component| InstallDependency[Install Dependency]
    ProblemSolving -->|Configuration issue for planning implementation| FixConfiguration[Fix Configuration]
    ProblemSolving -->|Knowledge gap in planning area| ResearchPlanningImplementation[Research Planning Implementation]
    ProblemSolving -->|Planned component complexity too high| BreakDownPlanningComponent[Break Down Planning Component]
    
    %% V6 ENHANCEMENT: CONTEXT INJECTION PATTERNS
    LoadPlanningContext --> InjectPlanningContext{ü§ñ Inject Planning Context}
    InjectPlanningContext --> LoadPhaseContext[ü§ñ Load Current Phase Context]
    LoadPhaseContext --> LoadComponentContext[ü§ñ Load Relevant Component Context]
    LoadComponentContext --> LoadTestContext[ü§ñ Load Test Layer Context]
    LoadTestContext --> LoadDependencyContext[ü§ñ Load Dependency Context]
    LoadDependencyContext --> ModeSelection
    
    %% CONTEXT-AWARE DECISION MAKING
    GatherPlanningContext --> InjectFullPlanningContext[ü§ñ Inject Full Planning Context]
    InjectFullPlanningContext --> LoadImplementationEvidence[ü§ñ Load Implementation Evidence]
    LoadImplementationEvidence --> LoadTestEvidence[ü§ñ Load Test Execution Evidence]
    LoadTestEvidence --> LoadArchitectureEvidence[ü§ñ Load Architecture Evidence]
    LoadArchitectureEvidence --> DocumentImplementationFinding
    
    %% WORKFLOW PROGRESSION (Enhanced)
    DoCommit --> UpdateTaskGraph[ü§ñ Update Task Graph Progress]
    UpdateTaskGraph --> NextPlanningTarget{üß† LLM: Determine Next Planning Target}
    RunPlanningDoublecheck --> NextPlanningTarget
    QuickFix --> ReturnToTests[Return to Test Check]
    FixImplementation --> ReturnToTests
    FixTests --> ReturnToTests
    
    NextPlanningTarget -->|More components in current planning phase| ReturnToPlanningSelection
    NextPlanningTarget -->|Current planning phase complete| AdvancePlanningPhase[Advance to Next Planning Phase]
    NextPlanningTarget -->|Need different planning approach| ChangePlanningStrategy[Change Planning Strategy]
    NextPlanningTarget -->|Task graph has next target| LoadTaskGraphTarget
    
    %% V6 ENHANCEMENT: INTELLIGENT COMPONENT SELECTION
    ReturnToPlanningSelection --> SelectNextPlanningComponent{üß† LLM: Next Planning Component}
    
    SelectNextPlanningComponent --> ComponentAnalysis{üß† LLM: Analyze Component Readiness}
    
    ComponentAnalysis -->|"Component ready for implementation<br/>with clear pseudocode"| ImplementComponent[Execute: Implement Component]
    ComponentAnalysis -->|"Component needs test clarification<br/>before implementation"| WriteComponentTests[Execute: Write Component Tests]
    ComponentAnalysis -->|"Component dependencies unclear<br/>need exploration"| ExploreComponent[Execute: Explore Component]
    ComponentAnalysis -->|"Component implemented but<br/>needs verification"| DoublecheckComponent[Execute: Doublecheck Component]
    ComponentAnalysis -->|"Component blocked by<br/>planning inconsistency"| PlanningInconsistencyDetected
    
    %% V6 ENHANCEMENT: EVIDENCE-BASED DEVELOPMENT
    EvidenceValidation --> EvidenceDirectoryCheck{ü§ñ Evidence Directory Structure Exists?}
    EvidenceDirectoryCheck -->|Missing| CreateEvidenceStructure[ü§ñ Create investigations/[area]/phase_X/ structure]
    EvidenceDirectoryCheck -->|Exists| EvidenceArtifactCheck{ü§ñ Required Evidence Artifacts Present?}
    
    CreateEvidenceStructure --> EvidenceArtifactCheck
    
    EvidenceArtifactCheck -->|All present| EvidenceContentValidation[ü§ñ Validate Evidence Content]
    EvidenceArtifactCheck -->|Missing artifacts| CreateMissingEvidence[Execute: Create Missing Evidence Files]
    
    CreateMissingEvidence --> RequiredEvidenceCreation{üß† LLM: Create Required Evidence}
    RequiredEvidenceCreation --> CreateFindingsFile[Execute: Create findings.md]
    CreateFindingsFile --> CreateTestResultsLog[Execute: Create test_results.log]
    CreateTestResultsLog --> CreateImplementationProof[Execute: Create implementation_proof.md]
    CreateImplementationProof --> CreateEvidenceManifest[ü§ñ Create evidence.json manifest]
    
    EvidenceContentValidation --> EvidenceCheck{ü§ñ Files Exist? Claims Match Planning Reality?}
    CreateEvidenceManifest --> EvidenceCheck
    
    EvidenceCheck -->|Evidence valid and matches planning| EvidenceLLMCheck{üß† LLM: Evidence Quality vs Planning Goals}
    EvidenceCheck -->|Evidence invalid or contradicts planning| PlanningInconsistencyDetected
    
    EvidenceLLMCheck -->|High quality evidence toward planning goals| EvidenceMetricsValidation[ü§ñ Validate Evidence Metrics]
    EvidenceLLMCheck -->|Low quality evidence for planning| RequestBetterPlanningEvidence[Request Better Evidence]
    
    EvidenceMetricsValidation -->|Metrics valid| ProceedWithPlanningEvidence[Proceed with Planning Evidence]
    EvidenceMetricsValidation -->|Metrics invalid| UpdateEvidenceMetrics[Execute: Update Evidence Metrics]
    
    UpdateEvidenceMetrics --> EvidenceMetricsValidation
    
    %% AUTOMATION HEALTH MONITORING (Enhanced)
    ContinueWork --> HealthCheck{‚ö° HYBRID: Automation Health Check}
    ProceedWithPlanningEvidence --> HealthCheck
    ReturnToTests --> HealthCheck
    
    HealthCheck --> QuickHealthCheck{ü§ñ Quick Health Indicators}
    
    QuickHealthCheck -->|"Planning progress detected<br/>Files being modified<br/>Error rate acceptable"| HealthGood[Health: Good]
    QuickHealthCheck -->|Warning signs detected| DeepHealthAnalysis{üß† LLM: Deep Health Analysis}
    
    DeepHealthAnalysis -->|Recoverable issues| HealthWarning[Health: Warning - Continue with Monitoring]
    DeepHealthAnalysis -->|Serious problems| HealthFailing[Health: Failing - Escalate]
    
    HealthGood --> UpdateCounters[ü§ñ Update Loop Counters]
    HealthWarning --> UpdateCounters
    HealthFailing --> EscalateHuman
    
    %% COUNTER MANAGEMENT (Enhanced)
    UpdateCounters --> TrackPlanningProgress[ü§ñ Track Planning Implementation Progress]
    TrackPlanningProgress --> IncrementCounters{ü§ñ Increment Counters}
    
    IncrementCounters --> ExecuteAction["`**EXECUTE DECISION**:
    Provide next instruction for planned implementation`"]
    
    %% NEW PLANNING-SPECIFIC FLOWS
    LoadAdditionalPlanningContext --> ReturnToPlanningSelection
    PivotToPlanningStrategy --> ReturnToPlanningSelection
    NewImplementationStrategy --> ReturnToTests
    SystemicPlanningIssue --> PlanningInconsistencyDetected
    RequestPlanningClarification --> ReturnToPlanningSelection
    HandoffToImplementation --> LoadPlanningContext
    
    %% TERMINAL STATES
    StopAutomation --> End([End: Manual Mode])
    EscalateManual --> End
    EscalateHuman --> End
    ExecuteAction --> End
    
    %% STYLING
    classDef programmaticNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef llmNode fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef hybridNode fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef actionNode fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef terminalNode fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#000
    classDef planningNode fill:#f3e5f5,stroke:#6a1b9a,stroke-width:3px,color:#000
    
    class ManualOverride,PlanningInputCheck,CheckIterationLimits,TestStatus,GitChanges,FailureCount,SimpleFailure,QuickHealthCheck,IncrementCounters,ReadCurrentPhase,LoadRelevantPseudocode,LoadTaskGraph,IdentifyImplementationTargets,LoadTaskGraphTarget,ValidateTaskDependencies,AnalyzeTestFailures,TestLayerConflictCheck,InjectPlanningContext,LoadPhaseContext,LoadComponentContext,LoadTestContext,LoadDependencyContext,InjectFullPlanningContext,LoadImplementationEvidence,LoadTestEvidence,LoadArchitectureEvidence,UpdateTaskGraph,QualityValidationPipeline,CrossReferenceIntegrityCheck,EvidenceCompletenessCheck,StateConsistencyCheck,AutomationHealthCheck,CreateErrorLog,UpdateErrorSummary,InjectCLAUDEMDError,ManualOverrideCreation,CreateWorkflowOverride,EvidenceDirectoryCheck,EvidenceArtifactCheck,EvidenceContentValidation,EvidenceCheck,EvidenceMetricsValidation,CreateEvidenceStructure,CreateEvidenceManifest,SpawnEvaluatorInstance,LogEvaluatorDecision,EvaluatorDecisionRouting,AntiCheatingEnforcement,DetectCheatingPatterns programmaticNode
    class ProgressAnalysis,CommitReady,StagnationAnalysis,ProblemSolving,LLMFailureAnalysis,RepeatedFailure,StuckOnPlanningProblem,NextPlanningTarget,SelectNextPlanningComponent,EvidenceLLMCheck,ModeSelection,GenerateTaskInstruction,SelectFailureToFix,ContextualPrioritization,ConsultPlanningStrategy,IdentifyConflictType,ResolveAcceptanceUnitConflict,ResolveContractImplConflict,ResolveExternalInternalConflict,ResolveMultiLayerConflict,ValidateTestResolution,ComponentAnalysis,EscalationStrategy,SimplifyObjective,UpdatePlanningObjective,RequiredEvidenceCreation,EvaluatorAssessment llmNode
    class AnalyzeFailure,HealthCheck,DeepHealthAnalysis,PlanningImplementationProblem hybridNode
    class DoCommit,RunPlanningDoublecheck,QuickFix,ExploreComponent,WriteComponentTests,ImplementComponent,DoublecheckComponent,ResolveDependencies,ResolveTestLayerConflicts,EscalateToDeferred,ArchiveEvidence,CreateMissingEvidence,CreateFindingsFile,CreateTestResultsLog,CreateImplementationProof,UpdateEvidenceMetrics,InjectCrossReferenceError,InjectEvidenceError,InjectStateError,InjectAutomationError actionNode
    class StopAutomation,EscalateManual,EscalateHuman,End terminalNode
    class LoadPlanningContext,PlanningInconsistencyDetected,FreshInstanceEval,ControlledPlanningReturn,ReturnToPlanningSelection,TaskGraphMode,TDDMode,HybridMode,FallbackTDDMode planningNode
```

## V6 Enhancement Summary

### üÜï **New Hybrid Planning-TDD Features**
- **Implementation Mode Selection**: Intelligent choice between Task-Graph, TDD, Hybrid, and Fallback modes
- **Task Graph Integration**: Direct integration with planning task dependency graphs
- **Test Layer Conflict Resolution**: Sophisticated handling of conflicts between acceptance, contract, unit, and external tests
- **Context Injection Patterns**: Systematic loading of planning, phase, component, test, and dependency contexts
- **Planning Inconsistency Detection**: Identifies when implementation contradicts planning with fresh instance evaluation

### üîÑ **Enhanced Implementation Modes**
- **Task-Graph Driven Mode**: Follows planning artifacts and dependency graphs for systematic implementation
- **TDD Failure-Driven Mode**: Traditional test-failure driven development with planning awareness
- **Hybrid Mode**: Intelligently switches between task-graph and TDD based on current context
- **Fallback Mode**: Pure TDD when planning context is insufficient or unclear

### üéØ **Key Decision Points Enhanced**
1. **Entry Point**: Planning artifacts available vs unknown state with comprehensive context loading
2. **Mode Selection**: Task-graph vs TDD vs hybrid based on planning readiness and test status
3. **Implementation Strategy**: Planning-guided component selection vs failure-driven fixing
4. **Conflict Resolution**: Multi-layer test conflict identification and resolution
5. **Context Injection**: Systematic loading of all relevant planning and implementation contexts
6. **Progress Tracking**: Task graph progress updates alongside traditional TDD progress

### üõ°Ô∏è **Anti-Fabrication Enhancements**
- **Planning Artifact Integrity**: Cannot modify planning artifacts during implementation
- **Fresh Instance Planning Evaluation**: Objective assessment of planning vs implementation issues using Task tool
- **Evidence Chain**: Links implementation evidence to planning requirements with comprehensive context
- **Controlled Planning Return**: Only legitimate planning issues trigger planning process return with evidence packages
- **Test Layer Validation**: Ensures consistency across multiple test layers (acceptance, contract, unit, external)

### üß† **Intelligence Classification Enhancements**
- **Expanded Programmatic Nodes**: Task graph loading, dependency validation, context injection, quality validation pipeline, evidence structure management
- **Enhanced LLM Decisions**: Mode selection, conflict resolution, component analysis, contextual prioritization, escalation strategies, fresh evaluator assessment
- **Improved Hybrid Nodes**: Planning-implementation problem diagnosis with full context awareness

### üõ†Ô∏è **Comprehensive Methodology Integration**
- **Error Management Workflow**: Automatic error injection into CLAUDE.md with structured logging in logs/errors/active/
- **Evidence-Based Development**: Complete investigations/ structure with findings.md, test_results.log, implementation_proof.md, and evidence.json manifests
- **Fresh Instance Evaluator System**: Comprehensive anti-cheating evaluation using Task tool spawning with scope reduction and quality compromise detection
- **Loop Breaking & Recovery**: Detailed iteration limits (7 uncertainty resolution, 3 stop hooks) with escalation strategies
- **Quality Validation Pipeline**: Cross-reference integrity, evidence completeness, state consistency, and automation health checks

### üîí **Advanced Anti-Fabrication System**
- **Test Modification Blocking**: Prevents unauthorized test changes during implementation
- **Mock Data Usage Detection**: Enforces real data requirements over mock substitutions  
- **Requirement Dropping Prevention**: Blocks attempts to remove or simplify requirements
- **Scope Reduction Rejection**: Fresh evaluator instances reject illegitimate scope changes
- **Evidence Chain Validation**: Complete evidence artifacts required for all completion claims

This V6 flowchart now fully incorporates the comprehensive methodology patterns from claude_code_and_repo_structuring_and_tools_etc_any_projectv4.md while preserving all V5 problem-solving capabilities and adding sophisticated planning-guided implementation selection.